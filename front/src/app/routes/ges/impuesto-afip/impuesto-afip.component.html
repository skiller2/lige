<nz-card class="small-margin">
  <form nz-form #impuestoForm="ngForm">
    <ng-container *ngIf="{ lista: (listaDescuentos$ | async) } as context">
      <ul nz-menu nzMode="horizontal">
        <li nz-menu-item nzSelected (click)="selectedTabIndex = 0">
          <span nz-icon nzType=""></span>
          Carga
        </li>
        <li nz-menu-item (click)="selectedTabIndex = 1">
          <span nz-icon nzType=""></span>
          Listado
        </li>
        <li nz-submenu nzTitle="Acciones" *ngIf="selectedTabIndex == 1">
          <ul>
            <li nz-menu-item app-down-file httpUrl="api/impuestos_afip/download/{{ anio }}/{{ mes }}/{{
                selectedPersonalId
              }}">
              <span nz-icon nzType="download"></span>Comprobantes
            </li>
            <li nz-menu-item (click)="exportGrid()">
              <span nz-icon nzType="download"></span>XLS
            </li>
          </ul>
        </li>
      </ul>

      <nz-date-picker nzMode="month" name="periodo" ngModel (ngModelChange)="onChange($event)" />

      <nz-tabset nzCentered [(nzSelectedIndex)]="selectedTabIndex" class="hide-ant-tabs-nav">
        <nz-tab>
          <div *ngIf="context.lista?.RegistrosSinComprobantes && 1" nz-col nzXs="24" nzSm="12" nzMd="6" class="mb-md">
            <div nz-row nzType="flex" nzAlign="middle" class="ant-btn-danger rounded-md">
              <div nz-col nzSpan="24" class="p-md text-white">
                <div class="h2 mt0">
                  Pendientes: {{ context.lista?.RegistrosSinComprobantes }}
                </div>
                <p class="text-nowrap mb0">
                  Cargados: {{ context.lista?.RegistrosConComprobantes }}
                </p>
              </div>
            </div>
          </div>

          <!-- <app-personal-search #searchForzado /> -->

          <nz-form-item>
            <nz-form-label [nzSpan]="5">Forzado</nz-form-label>
            <nz-form-control>
              <ng-container>
                <input #montoForzado type="number" [placeholder]="'Monto'" nz-input name="monto" ngModel />
                <input #cuitForzado type="number" [placeholder]="'CUIT'" nz-input name="cuitForzado" ngModel />

                <nz-upload nzAccept="application/pdf" [nzAction]="url_forzado" [nzData]="{
                    anio: anio,
                    mes: mes,
                    cuit: cuitForzado.value,
                    monto: montoForzado.valueAsNumber
                  }" nzName="pdf">
                  <button nz-button>
                    <span nz-icon nzType="upload"></span>
                    Subir Comprobante (Forzado)
                  </button>
                </nz-upload>
              </ng-container>
            </nz-form-control>
          </nz-form-item>
          <nz-upload class="d-block" nzType="drag" [nzMultiple]="true" [nzData]="{ anio: anio, mes: mes }"
            (nzChange)="handleChange($event)" [nzAction]="url" nzName="pdf" [(nzFileList)]="files"
            nzAccept="application/pdf">
            <p class="ant-upload-drag-icon">
              <span nz-icon nzType="inbox"></span>
            </p>
            <p class="ant-upload-text">
              Clickeá or arrastrá archivos para cargar
            </p>
          </nz-upload>

          <!-- <nz-table
            class="app-table"
            #tablaDescuentos
            [nzData]="context.lista?.Registros || []"
            nzSize="small"
            [nzLoading]="tableLoading$ | async"
            [nzPageSize]="100000000"
            [nzShowPagination]="false">
            <thead>
              <tr>
                <th
                  *ngFor="let column of listOfColumns"
                  [(nzSortOrder)]="column.sortOrder"
                  [nzSortFn]="column.sortFn"
                  [nzFilters]="column.listOfFilter"
                  [nzFilterFn]="column.filterFn">
                  {{ column.name }}
                </th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let data of tablaDescuentos.data">
                <td>{{ data.CUIT }}</td>
                <td>
                  {{ data.ApellidoNombre }}
                  <button
                    nz-button
                    *ngIf="data.PersonalOtroDescuentoDescuentoId"
                    (click)="downloadAction$.next(data)">
                    <span nz-icon nzType="download"></span>
                  </button>
                </td>
                <td>{{ data.PersonalEstado }}</td>
                <td>{{ data.monto | currency }}</td>
                <td>{{ data.CUITJ }}</td>
                <td>{{ data.ApellidoNombreJ }}</td>
              </tr>
            </tbody>
          </nz-table> -->
        </nz-tab>
        <nz-tab [nzForceRender]="false">
          <ng-template nz-tab>
            <div nz-row nzJustify="space-around">
              <div nz-col [nzSpan]="13" style="text-align: center">
                <label>Persona Responsable</label>
                <app-personal-search
                  (ngModelChange)="formChanged($event)"
                  [(ngModel)]="selectedPersonalId"
                  [ngModelOptions]="{ standalone: true }" />
              </div>
            </div>

            <!--
            <st
              #st
              [data]="'/api/impuestos_afip/list'"
              [res]="{ reName: { total: 'data.total', list: 'data.list' } }"
              [req]="{
                lazyLoad: true,
                params: { anio, mes, options: listOptions, toggle },
                method: 'POST',
                allInBody: true
              }"
              [columns]="columns$ | async"
              class="mt-sm"
              virtualScroll
              [scroll]="{ y: 'calc(100vh - 310px)' }"
              resizable
              [page]="{ show: false }"
              [widthMode]="{ type: 'strict' }">
              <ng-template st-row="cusImporte" let-item>
                <span nz-tooltip [nzTooltipTitle]="">{{
                  item.monto | currency
                }}</span>
                <a
                  *ngIf="item.monto > 0"
                  app-down-file
                  title="Comprobante {{
                    item.PersonalOtroDescuentoMesesAplica
                  }}/{{ item.PersonalOtroDescuentoAnoAplica }}"
                  httpUrl="api/impuestos_afip/{{
                    item.PersonalOtroDescuentoAnoAplica
                  }}/{{ item.PersonalOtroDescuentoMesesAplica }}/0/{{
                    item.PersonalId
                  }}"
                  ><span class="pl-xs" nz-icon nzType="download"></span
                ></a>
              </ng-template>
            </st>
-->
            <shared-filtro-builder [fieldsToSelect]="(columns$ | async)" (optionsChange)="listOptionsChange($event)" />

            <ng-template #defaultTmpl></ng-template>

            <ng-container *ngIf="(columns$ | async) as colsdefs; else defaultTmpl">

              <div class="gridContainer container-fluid">
                <angular-slickgrid gridId="grid22" class="gridContainer" [columnDefinitions]="colsdefs"
                  [gridOptions]="gridOptions" [dataset]="(gridData$ | async) || []"
                  (onAngularGridCreated)="angularGridReady($event)">

                </angular-slickgrid>
              </div>
            </ng-container>

          </ng-template>
        </nz-tab>
      </nz-tabset>
    </ng-container>
  </form>
</nz-card>