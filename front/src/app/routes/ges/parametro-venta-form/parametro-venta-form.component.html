<form (ngSubmit)="save()">
  <p>parametroVenta: {{ parametroVenta() |json}}</p>
  <nz-form-item class="marginElement" style="display:none">
    <nz-form-label [nzXs]="24" [nzSm]="24" [nzMd]="6">codobjId</nz-form-label>
    <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="16">
      <input nz-input placeholder="" [formField]="formParametroVenta.codobjId" type="string" />
    </nz-form-control>
  </nz-form-item>

  <nz-form-item class="marginElement">
    <nz-form-label [nzXs]="24" [nzSm]="24" [nzMd]="6">Objetivo</nz-form-label>
    <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="16">
      <app-objetivo-search [formField]="formParametroVenta.ObjetivoId"
        (valueExtendedChange)="objetivoDetalleChange($event)"></app-objetivo-search>
    </nz-form-control>
  </nz-form-item>

  <nz-form-item class="marginElement">
    <nz-form-label [nzXs]="24" [nzSm]="24" [nzMd]="6">Aplica Desde</nz-form-label>
    <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="8">
      <nz-date-picker [formField]="formParametroVenta.PeriodoDesdeAplica" nzMode="month" nzFormat="MM/yyyy"
        style="width: 100%;">
      </nz-date-picker>

    </nz-form-control>
  </nz-form-item>



  <nz-form-item class="marginElement">
    <nz-form-label [nzXs]="24" [nzSm]="24" [nzMd]="6">Periodo de Facturación</nz-form-label>
    <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="4" nzHasFeedback >
      <input nz-input [formField]="formParametroVenta.PeriodoFacturacion" placeholder="Ej: 1S, 1M, 1A" />

      @if (formParametroVenta.PeriodoFacturacion().touched() && formParametroVenta.PeriodoFacturacion().invalid()) {
        @for (e of formParametroVenta.PeriodoFacturacion().errors(); track e.kind) {
          <div class="ant-form-item-explain-error">{{ e.message ?? e.kind }}</div>
        }
      }
</nz-form-control>

    @if (periodoFacturacionDescripcion()) {
      <span style="margin-left: 8px; line-height: 32px; color: rgba(0, 0, 0, 0.65);">
        {{ periodoFacturacionDescripcion() }}
      </span>
    }

    @if (periodoFacturacionDias()>=60) {
    <nz-form-label [nzXs]="24" [nzSm]="24" [nzMd]="3" style="margin-left: 16px;">Inicio</nz-form-label>
    <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="4">
      <nz-date-picker [formField]="formParametroVenta.PeriodoFacturacionInicio" nzMode="month" nzFormat="MM/yyyy" style="width: 100%;">
      </nz-date-picker>
    </nz-form-control>
    }
  </nz-form-item>

  <nz-form-item class="marginElement">
    <nz-form-label [nzXs]="24" [nzSm]="24" [nzMd]="6">Día de Generación Factura</nz-form-label>
    <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="4" nzHasFeedback >
      <input nz-input [formField]="formParametroVenta.GeneracionFacturaDia" type="number"
        placeholder="Día del mes (1-31)" style="width: 100%;">

     @if (formParametroVenta.GeneracionFacturaDia().touched() && formParametroVenta.GeneracionFacturaDia().invalid()) {
        @for (e of formParametroVenta.GeneracionFacturaDia().errors(); track e.kind) {
          <div class="ant-form-item-explain-error">{{ e.message ?? e.kind }}</div>
        }
      }

    </nz-form-control>
    <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="6" style="margin-left: 16px;">
      <label nz-checkbox [formField]="formParametroVenta.GeneracionFacturaReqCliente">Requerido por Cliente</label>
    </nz-form-control>
  </nz-form-item>

  <nz-form-item class="marginElement">
    <nz-form-label [nzXs]="24" [nzSm]="24" [nzMd]="6">Día de Generación Factura (Complemento)</nz-form-label>
    <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="11" nzHasFeedback
      >
      <input nz-input [formField]="formParametroVenta.GeneracionFacturaDiaComplemento" type="number"
        placeholder="Día complemento (1-31 o vacío)" style="width: 100%;">

      @if (formParametroVenta.GeneracionFacturaDiaComplemento().touched() && formParametroVenta.GeneracionFacturaDiaComplemento().invalid()) {
        @for (e of formParametroVenta.GeneracionFacturaDiaComplemento().errors(); track e.kind) {
          <div class="ant-form-item-explain-error">{{ e.message ?? e.kind }}</div>
        }
      }
    </nz-form-control>
  </nz-form-item>

  <nz-form-item class="marginElement">
    <nz-form-label [nzXs]="24" [nzSm]="24" [nzMd]="6">Unificación Factura</nz-form-label>
    <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="8">
      <label nz-checkbox [formField]="formParametroVenta.UnificacionFactura"></label>
    </nz-form-control>
  </nz-form-item>

  <nz-form-item class="marginElement">
    <nz-form-label [nzXs]="24" [nzSm]="24" [nzMd]="6">Observaciones</nz-form-label>
    <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="16">
      <textarea nz-input [formField]="formParametroVenta.Observaciones" placeholder="Ingrese observaciones"
        [nzAutosize]="{ minRows: 3, maxRows: 6 }">
      </textarea>
    </nz-form-control>
  </nz-form-item>


  <div class="input-container">
    <div class="input-label">Productos {{formParametroVenta.infoProductos.length}}</div>
  </div>
  <div style="padding-top: 25px;">

  @for (_ of formParametroVenta.infoProductos; let i = $index; track i) {
    <div [ngClass]="{'even-background': i % 2 === 0}" [style.margin-top.px]="i % 2 !== 0 ? 15 : 0">

      <nz-form-item class="marginElement">
        <nz-form-label [nzXs]="24" [nzSm]="24" [nzMd]="3">Producto</nz-form-label>
        <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="3" [nzLg]="5">
          <nz-select nzAllowClear style="width:100%" nzPlaceholder="Producto" [formField]="formParametroVenta.infoProductos[i].ProductoCodigo"
            nzShowSearch [nzDropdownMatchSelectWidth]="false" >
            @for (option of optionsTipoProducto(); track option.ProductoCodigo) {
            <nz-option [nzValue]="option.ProductoCodigo" [nzLabel]="option.Nombre"></nz-option>
            }
          </nz-select>
          @if (formParametroVenta.infoProductos[i].ProductoCodigo().touched() && formParametroVenta.infoProductos[i].ProductoCodigo().invalid()) {
              @for (e of formParametroVenta.infoProductos[i].ProductoCodigo().errors(); track e.kind) {
                <div class="ant-form-item-explain-error">{{ e.message ?? e.kind }}</div>
              }
            }
        </nz-form-control>
      </nz-form-item>


      <nz-form-item class="marginElement">

        <nz-form-label [nzXs]="24" [nzSm]="24" [nzMd]="3">Tipo Importe</nz-form-label>
        <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="3" [nzLg]="5">
          <nz-select [formField]="formParametroVenta.infoProductos[i].TipoImporte" style="width: 100%" nzPlaceholder="Seleccione" nzAllowClear
            [nzDropdownMatchSelectWidth]="false" >
            @for (option of optionsTipoImporte(); track option.value) {
            <nz-option [nzValue]="option.value" [nzLabel]="option.label"></nz-option>
            }

          </nz-select>
        </nz-form-control>
        <nz-form-label [nzXs]="24" [nzSm]="24" [nzMd]="3">Importe Unitario</nz-form-label>
        <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="8" [nzLg]="8">
          @if (parametroVenta().infoProductos[i].TipoImporte === 'V') {
            <div style="padding: 4px 11px; color: rgba(0, 0, 0, 0.65); font-style: italic;">
              Cargar en el cierre de planilla por el responsable
            </div>
          } @else if (parametroVenta().infoProductos[i].TipoImporte === 'LP') {
            <div style="padding: 4px 11px; color: rgba(0, 0, 0, 0.65); font-style: italic;">
              {{ getImporteUnitario()[i] || 'Sin importe unitario cargado en lista de precios' }}
            </div>
          } @else {
            <input
              appDotToComma
              mask="separator.2"
              nz-input
              nzInputNumber
              style="width: 100%"
              [formField]="formParametroVenta.infoProductos[i].ImporteUnitario"
              type="text"
              min="0"
              step="0.01"
              placeholder="Importe Unitario"
              nz-tooltip
            >
          }
        </nz-form-control>



      </nz-form-item>

      <nz-form-item class="marginElement">

        <nz-form-label [nzXs]="24" [nzSm]="24" [nzMd]="3">Tipo Cantidad</nz-form-label>
        <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="3" [nzLg]="5">
          <nz-select [formField]="formParametroVenta.infoProductos[i].TipoCantidad" style="width: 100%" nzPlaceholder="Seleccione" nzAllowClear
            [nzDropdownMatchSelectWidth]="false" >
            @for (option of optionsTipoCantidad(); track option.value) {
            <nz-option [nzValue]="option.value" [nzLabel]="option.label"></nz-option>
            }

          </nz-select>
        </nz-form-control>

        <nz-form-label [nzXs]="24" [nzSm]="24" [nzMd]="3">Cantidad</nz-form-label>
        <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="3" [nzLg]="5">

          @if (parametroVenta().infoProductos[i].TipoCantidad === 'V') {
            <div style="padding: 4px 11px; color: rgba(0, 0, 0, 0.65); font-style: italic;">
              Cargar en el cierre de planilla por el responsable
            </div>
          } @else if (parametroVenta().infoProductos[i].TipoCantidad === 'A' || parametroVenta().infoProductos[i].TipoCantidad === 'B') {
            <div style="padding: 4px 11px; color: rgba(0, 0, 0, 0.65); font-style: italic;">
              {{ getMensajeHoras(i) || 'Cargando...' }}
            </div>
          } @else {
            <input
            appDotToComma
            mask="separator.2"
            nz-input
            nzInputNumber
            [formField]="formParametroVenta.infoProductos[i].CantidadHoras"
            type="text"
            style="width: 100%;"
            placeholder="Cantidad"
            nz-tooltip
            
          >
          }
         
        </nz-form-control>

      </nz-form-item>

      <nz-form-item class="marginElement">

        <nz-form-label [nzXs]="24" [nzSm]="24" [nzMd]="3">Texto Factura</nz-form-label>
        <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="3" [nzLg]="16" nz-popover
          [nzPopoverContent]="textFacturaTemplate">
          <textarea nz-input [formField]="formParametroVenta.infoProductos[i].TextoFactura" rows="3" style="width: 100%;"
            nzPlaceholder="Ingrese el texto de la factura"></textarea>
          <p style="color:rgba(0, 0, 0, 0.347); margin-top: 8px;">Vista previa: {{ getTextoFacturaPreview()[i] }}</p> 
        </nz-form-control>

        @if (true) {
        <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="2" class="button-group-direction">
          <div class="button-group" style="width: 100%">
            @if (formParametroVenta.infoProductos.length == i+1) {
            <button nz-button class="add-button" nzType="primary" class="add-button" (click)="addProductos($event)"
              nz-tooltip nzTooltipTitle="{{ 'app.icon.add' | i18n }}">
              <span nz-icon nzType="plus"></span>
            </button>
            }
            @if (formParametroVenta.infoProductos.length >= 2) {
            <button nz-button nzType="default" (click)="removeProductos(i, $event)" nz-tooltip
              nzTooltipTitle="{{ 'app.icon.delete' | i18n }}">
              <span nz-icon nzType="delete" nzTheme="outline"></span>
            </button>
            }
          </div>
        </nz-form-control>
        }

      </nz-form-item>
</div>

  }
</div>

  @if (true) {
    <p>Dirty {{formParametroVenta().dirty()|json}}</p>
  <nz-form-item class="btn-margintop">
    <nz-form-control style="display: flex; justify-content: center; align-items: center; gap: 8px;">
      <button style="margin-right: 10px;" nzType="primary" nz-button type="submit" [nzLoading]="formParametroVenta().submitting()"
          [disabled]="formParametroVenta().submitting() || formParametroVenta().dirty()==false">
        {{ 'app.btn.save' | i18n }}
      </button>
      <button nz-button nzType="default" (click)="clearForm()" type="button">
        {{ 'app.btn.clear.form' | i18n }}
      </button>
    </nz-form-control>
  </nz-form-item>

  }
</form>
