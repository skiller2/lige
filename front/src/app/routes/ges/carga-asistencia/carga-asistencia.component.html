<nz-card class="small-margin">

    <form nz-form #carasistForm="ngForm">

        <nz-form-item>
            <nz-form-label [nzSpan]="3">Periodo</nz-form-label>
            <nz-form-control [nzSpan]="5">

                <nz-date-picker nzMode="month" name="periodo" ngModel
                    (ngModelChange)="formChange($event,Busqueda.Periodo)" nzFormat="MM/yyyy" />
            </nz-form-control>
            <nz-form-control [nzSpan]="16" style="text-align: right;" *ngIf="selectedObjetivoId>0">
                <nz-button-group>
                    <button nz-button nzType="default"
                        [routerLink]="['/ges/asistencia_excepcion',{ObjetivoId:this.selectedObjetivoId}]"><span nz-icon
                            nzType="right" nzTheme="outline"></span>Excepción Art14</button>
                    <button nz-button nzType="default" nz-popconfirm
                        nzPopconfirmTitle="Cargo vigiladores del mes anterior?" (nzOnConfirm)="autocomplete()"
                        *ngIf="gridDataInsert.length <= 1 && gridOptionsEdit.editable"><span nz-icon nzType="copy"
                            nzTheme="outline"></span>Copia mes anterior</button>

                    <button nz-button nzType="primary" nz-popconfirm
                        *ngIf="(periodos && (periodos[0]?.ObjetivoAsistenciaAnoMesDesde == null || periodos[0]?.ObjetivoAsistenciaAnoMesHasta != null))"
                        nzPopconfirmTitle="Habilita carga asistencia?" [nzBeforeConfirm]=""
                        [nzPopconfirmShowArrow]="false" (nzOnConfirm)="setCargaAsistencia()"><span nz-icon nzType="plus"
                            nzTheme="outline"></span>Inicia
                        Carga</button>
                    <button nz-button nzType="primary" nz-popconfirm nzPopconfirmTitle="Cierra carga asistencia?"
                        *ngIf="periodos &&  periodos[0]?.ObjetivoAsistenciaAnoMesHasta == null && periodos[0]?.ObjetivoAsistenciaAnoMesDesde != null"
                        [nzBeforeConfirm]="" [nzPopconfirmShowArrow]="false" (nzOnConfirm)="endCargaAsistencia()"><span
                            nz-icon nzType="check" nzTheme="outline"></span>Finaliza
                        Carga</button>
                </nz-button-group>
            </nz-form-control>
        </nz-form-item>
        <nz-form-item>
            <nz-form-label [nzSpan]="3">Objetivo</nz-form-label>
            <nz-form-control [nzSpan]="21">
                <ng-template #suffixReloadTpl>
                    <a (click)="formChange('', Busqueda.Objetivo)"><span nz-icon nzType="reload"
                            nzTheme="outline"></span></a>
                </ng-template>
                <nz-input-group [nzAddOnAfter]="suffixReloadTpl" style="width: 100%">
                    <app-objetivo-search [(ngModel)]="selectedObjetivoId" name="ObjetivoId"
                        (ngModelChange)="formChange($event, Busqueda.Objetivo)" ngModel />

                </nz-input-group>
            </nz-form-control>
        </nz-form-item>
        <ng-container *ngIf="$objetivoDetalle| async as objetivoDetalle">
            <nz-form-item>
                <nz-form-label [nzSpan]="3">Responsable</nz-form-label>
                <nz-form-control [nzSpan]="21">
                    <nz-collapse nzBordered="false" nzGhost="false" class="app-collapse-header"
                        *ngIf="objetivoDetalle.responsable.length">
                        <nz-collapse-panel
                            [nzHeader]="objetivoDetalle.responsable[0]?.tipo+' '+objetivoDetalle.responsable[0]?.detalle"
                            (nzActiveChange)="collapseChange($event)">
                            <ng-container *ngFor="let responsable of objetivoDetalle.responsable">
                                <li *ngIf="responsable.ord !=1" title="{{ responsable.id }}">
                                    {{responsable.tipo}} {{responsable.detalle}} desde {{ responsable.desde | date}}
                                    <span *ngIf="responsable.hasta
                        ">hasta</span> {{responsable.hasta | date}}
                                </li>
                            </ng-container>
                        </nz-collapse-panel>
                    </nz-collapse>
                </nz-form-control>
            </nz-form-item>
            <nz-form-item>
                <nz-form-label [nzSpan]="3">Contrato</nz-form-label>
                <nz-form-control [nzSpan]="10">
                    <ng-container *ngFor="let contrato of objetivoDetalle.contratos">
                        <li>Desde {{contrato.ContratoFechaDesde | date}} <span
                                *ngIf="contrato.ContratoFechaHasta">hasta</span>
                            {{ contrato.ContratoFechaHasta | date}} </li>
                    </ng-container>
                </nz-form-control>
                <nz-form-control [nzSpan]="11" style="text-align: right;">
                    <nz-button-group>
                        <button nz-button nzType="default" (click)="openDrawer()"><span nz-icon nzType="user"
                                nzTheme="outline"></span></button>
                    </nz-button-group>
                </nz-form-control>

            </nz-form-item>
        </ng-container>
    </form>
    <div class="grid-container-asis container-fluid">
        <angular-slickgrid gridId="gridEdit" [columnDefinitions]="columnas | colsFilter" [gridOptions]="gridOptionsEdit"
            [dataset]="gridDataInsert || []" (onCellChange)="onCellChanged($event)"
            (onAngularGridCreated)="angularGridReadyEdit($event)">
            <!-- (onBeforeEditCell)="onBeforeEditCell($event)" -->
        </angular-slickgrid>
    </div>
</nz-card>
<nz-drawer [nzClosable]="true" [nzVisible]="visibleDrawer" [nzPlacement]="'left'" [nzTitle]="personalApellidoNombre"
    (nzOnClose)="closeDrawer()">
    <ng-container *nzDrawerContent>
        <div class="app-foto-container" *ngIf="(personalDetalle$ | async) as imgdata">
            <img class="app-foto" nz-image [nzSrc]="imgdata.image"
                nzFallback="./assets/dummy-person-image.jpg" />
        </div>
        @if ((personalDetalleCategorias$ | async)?.categorias; as categorias){
        @if (categorias.length){ <h4>Categorías</h4>}
        @for (cat of categorias; track cat.PersonalCategoriaCategoriaPersonalId) {
        <li> {{cat.CategoriaPersonalDescripcion}} {{cat.ValorLiquidacionHoraNormal|currency}}
            {{(cat.ValorLiquidacionHorasTrabajoHoraNormal>0)?'('+cat.ValorLiquidacionHorasTrabajoHoraNormal+' hs)':''}}
        </li>
        }
        }
        @if ((personalDetalleLicencias$ |async)?.licencias; as licencias){
        @if (licencias.length){<h4>Licencia</h4>}
        @for (lic of licencias; track lic.desde) {
        <li> {{lic.desde|date }} {{lic.hasta2|date}}</li>
        }
        }
        @if (personalDetalleSitRevista$ | async; as situacion){
        @if (situacion.length) {<h4>Situacion Revista</h4>}
        @for (sit of situacion; track sit.PersonalSituacionRevistaDesde) {
        <li>{{sit.SituacionRevistaDescripcion}} {{sit.PersonalSituacionRevistaDesde|date }}
            {{sit.PersonalSituacionRevistaHasta|date}}</li>
        }
        }
        @if (personalDetalleResponsables$ | async; as responsables){
        @if (responsables.length) { <h4>Responsable</h4>}
        @for (responsable of responsables; track responsable.id) {
        <li title="{{ responsable.id }}">
            {{responsable.tipo}} {{responsable.detalle}} desde {{ responsable.desde | date}} <span *ngIf="responsable.hasta
            ">hasta</span> {{responsable.hasta | date}}</li> }
        }
    </ng-container>
</nz-drawer>