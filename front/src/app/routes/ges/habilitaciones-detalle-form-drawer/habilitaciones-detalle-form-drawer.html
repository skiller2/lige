<nz-drawer [nzClosable]="false" [nzVisible]="visible()" [nzPlacement]="placement" [nzWidth]="640"
  [nzTitle]="tituloDrawer()" (nzOnClose)="visible.set(false)">
  <ng-container *nzDrawerContent>
    <form [formGroup]="formHabilitacion">

      <nz-form-item class="marginElement">
        <nz-form-label [nzXs]="24" [nzSm]="24" [nzMd]="4">Tipo</nz-form-label>
        <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="19">
          <nz-select formControlName="PersonalHabilitacionClase" nzPlaceHolder="Seleccione tipo" nzAllowClear [nzDropdownMatchSelectWidth]="false" style="width: 100%">
            <nz-option nzValue="H" nzLabel="Habilitación"></nz-option>
            <nz-option nzValue="R" nzLabel="Renovación"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item class="marginElement">
        <nz-form-label [nzXs]="24" [nzSm]="24" [nzMd]="4">Personal</nz-form-label>
        <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="19">
          <app-personal-search formControlName="PersonalId" [anio]="anio()" [mes]="mes()"/>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item class="marginElement">
        <nz-form-label [nzXs]="5">Situación Revista</nz-form-label>
        <nz-form-control>
          @for (sitrevista of $sitrevista | async; track sitrevista) {
            <p title="{{ sitrevista.SituacionRevistaDescripcion }}">
              {{ sitrevista.SituacionRevistaDescripcion }} desde {{ sitrevista.PersonalSituacionRevistaDesde | date}}
              @if (sitrevista.PersonalSituacionRevistaHasta) {
                <span>hasta {{ sitrevista.PersonalSituacionRevistaHasta
                | date}}</span>
              }
            </p>
          }
        </nz-form-control>
      </nz-form-item>

      <nz-form-item class="marginElement">
        <nz-form-label [nzXs]="24" [nzSm]="24" [nzMd]="5">Lugar Habilitación</nz-form-label>
        <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="18">
          <nz-select formControlName="LugarHabilitacionId" nzPlaceHolder="Seleccione lugar" nzAllowClear 
           [nzDropdownMatchSelectWidth]="false" style="width: 100%">
            @for (option of $optionsLugarHabilitacion | async; track option) {
              <nz-option [nzValue]="option.value" [nzLabel]="option.label"></nz-option>
            }
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-divider nzText="Gestión"></nz-divider> <br />

      <nz-form-item class="marginElement">
        <nz-form-label [nzXs]="24" [nzSm]="24" [nzMd]="4">Estado</nz-form-label>
        <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="19">
          <nz-select formControlName="GestionHabilitacionEstadoCodigo" nzPlaceHolder="Seleccione estado" nzAllowClear
          [nzDropdownMatchSelectWidth]="false" style="width: 100%"
          (nzBlur)="formHabilitacion.patchValue({NroTramite:'',PersonalHabilitacionDesde:'',PersonalHabilitacionHasta:''})">
            @for (option of $optionsEstadoCodigo | async; track option) {
              <nz-option [nzValue]="option.value" [nzLabel]="option.label"></nz-option>
            }
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item class="marginElement">
        <nz-form-label [nzXs]="24" [nzSm]="24" [nzMd]="4">Detalle</nz-form-label>
        <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="19">
          <textarea  nz-input formControlName="Detalle" ></textarea>
        </nz-form-control>
      </nz-form-item>

      @if (GestionHabilitacionEstadoCodigo() == 'HABORG'){
      <nz-form-item class="marginElement">
        <nz-form-label [nzXs]="24" [nzSm]="24" [nzMd]="4">Nro tramite</nz-form-label>
        <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="19">
          <input nz-input placeholder="" formControlName="NroTramite" type="text"/>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item class="marginElement">
        <nz-form-label [nzXs]="24" [nzSm]="24" [nzMd]="4">Desde</nz-form-label>
        <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="8">
          <nz-date-picker
            formControlName="PersonalHabilitacionDesde"
            nzFormat="yyyy-MM-dd"
            nzMode="date"
            style="width: 100%;">
          </nz-date-picker>
        </nz-form-control>

        <nz-form-label [nzXs]="24" [nzSm]="24" [nzMd]="3">Hasta</nz-form-label>
        <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="8">
          <nz-date-picker
            formControlName="PersonalHabilitacionHasta"
            nzFormat="yyyy-MM-dd"
            nzMode="date"
            style="width: 100%;">
          </nz-date-picker>
        </nz-form-control>
      </nz-form-item>
      }

      @if (GestionHabilitacionCodigo()) {
      <nz-form-item class="marginElement">
        <nz-form-label [nzXs]="24" [nzSm]="24" [nzMd]="4">Fecha Ingreso</nz-form-label>
        <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="19">
          <input nz-input placeholder="" formControlName="AudFechaIng" type="text" readonly/>
        </nz-form-control>
      </nz-form-item>
      }

      @if (!GestionHabilitacionCodigo()) {
      <div formArrayName="documentos">
        <!-- @for (control of documentos().controls; track $index) { -->
        <div *ngFor="let control of documentos().controls; let i = index" [formGroupName]="i">
          <nz-form-item class="marginElement">
            <nz-form-label [nzXs]="24" [nzSm]="24" [nzMd]="4">Documentos</nz-form-label>
            <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="16">
              <app-file-upload formControlName="files" [idForSearh]="0" [cantMaxFiles]="1" [textForSearch]="''"
                [columnForSearch]="'DocumentoId'" [tableForSearch]="'Documento'" [showTipoDocs]="true"
                (prevFiles)="handlePrevFiles($event)" [showDesdeHasta]="true"></app-file-upload>
            </nz-form-control>

            <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="3" [nzLg]="3">

              <!-- No debe agregar el boton, solo debe crear un nuevo componente cuando detecte que haya un documento cargado -->
              <!-- <button nz-button *ngIf="documentos().controls.length == i+1  && formHabilitacion.enabled" nzType="primary" class="add-button" (click)="addDoc($event)" nz-tooltip
                nzTooltipTitle="{{ 'app.icon.add' | i18n }}">
                <span nz-icon nzType="plus"></span>
              </button> -->

              @if (documentos().controls.length > 1 && formHabilitacion.enabled) {
              <button nz-button nzType="default" (click)="removeDoc(i, $event)" nz-tooltip
                nzTooltipTitle="{{ 'app.icon.borrar' | i18n }}">
                <span nz-icon nzType="delete" nzTheme="outline"></span>
              </button>
              }
            </nz-form-control>
          </nz-form-item>

        </div>
      </div>
      }

      <nz-form-item>
        <nz-form-control style="display: flex; justify-content: center; align-items: center;">
          @if (formHabilitacion.enabled) {
            <button nzType="primary" nz-button (click)="save()" [nzLoading]="isLoading()"
              [disabled]="formHabilitacion.pristine">
              {{ 'app.btn.save' | i18n }}
            </button>
          }
        </nz-form-control>
      </nz-form-item>

    </form>
  </ng-container>
</nz-drawer>